{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .help-text {
            color: #666;
            font-size: 13px;
            margin-top: 4px;
        }
        .file-upload-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .alert-info {
            background-color: #d9edf7;
            border-color: #bce8f1;
            color: #31708f;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            gap: 10px;
        }
        .image-item {
            width: 120px;
            height: 120px;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .upload-drop-zone {
            height: 200px;
            border: 3px dashed #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
        }
        .upload-drop-zone.highlight {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
        .drag-text {
            text-align: center;
            padding: 15px;
        }
        .file-select-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .upload-info {
            margin-top: 20px;
            text-align: center;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('upload-drop-zone');
            const fileInput = document.getElementById('id_images');
            const previewContainer = document.getElementById('image-preview');
            const selectedCount = document.getElementById('selected-count');
            const uploadForm = document.getElementById('upload-form');
            
            // Prevent default behavior for drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight drop zone when dragging over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropZone.classList.add('highlight');
            }
            
            function unhighlight() {
                dropZone.classList.remove('highlight');
            }
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                updateImagePreview(files);
            }
            
            // Handle file input change
            fileInput.addEventListener('change', function() {
                updateImagePreview(this.files);
            });
            
            // Clicking on drop zone triggers file input
            dropZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            function updateImagePreview(files) {
                previewContainer.innerHTML = '';
                
                if (files.length > 0) {
                    selectedCount.textContent = `${files.length} file(s) selected`;
                    
                    for (let i = 0; i < Math.min(files.length, 12); i++) {
                        const file = files[i];
                        if (!file.type.startsWith('image/')) continue;
                        
                        const reader = new FileReader();
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';
                        
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            imageItem.appendChild(img);
                        };
                        
                        reader.readAsDataURL(file);
                        previewContainer.appendChild(imageItem);
                    }
                    
                    if (files.length > 12) {
                        const moreText = document.createElement('div');
                        moreText.textContent = `+ ${files.length - 12} more`;
                        moreText.className = 'image-item';
                        moreText.style.display = 'flex';
                        moreText.style.alignItems = 'center';
                        moreText.style.justifyContent = 'center';
                        previewContainer.appendChild(moreText);
                    }
                } else {
                    selectedCount.textContent = 'No files selected';
                }
            }
        });
    </script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:main_galleryimage_changelist' %}">Gallery Images</a>
&rsaquo; Upload Multiple Images
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="alert-info">
        <p><strong>Instructions:</strong> Use this form to upload multiple gallery images at once. All images will be assigned to the selected category and given sequential names based on the title prefix you provide.</p>
        <p><strong>To upload multiple images:</strong> Drag and drop multiple files onto the upload zone OR click the upload zone and select multiple files by holding Ctrl (or Command on Mac) while selecting.</p>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="upload-form">
        {% csrf_token %}
        <fieldset class="module aligned">
            {% for field in form %}
                <div class="form-row">
                    <div class="field-box">
                        {{ field.errors }}
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}
                            <div class="help-text">{{ field.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            
            <!-- Custom file upload zone -->
            <div class="form-row">
                <div class="field-box">
                    <label>Images:</label>
                    <div id="upload-drop-zone" class="upload-drop-zone">
                        <div class="drag-text">
                            <h3>Drag & Drop Images Here</h3>
                            <p>or click to select files</p>
                        </div>
                    </div>
                    <input type="file" id="id_images" name="images" multiple accept="image/*" style="display: none;">
                    <div id="selected-count" class="upload-info">No files selected</div>
                    <div id="image-preview" class="image-preview"></div>
                </div>
            </div>
        </fieldset>
        
        <div class="submit-row">
            <input type="submit" value="Upload Images" class="default" name="_save">
        </div>
    </form>
</div>
{% endblock %}
